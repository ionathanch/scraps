-- Set is a category with a terminal element âŠ¤
open import Agda.Builtin.Unit

ğ’ : Setâ‚
ğ’ = Set

_â‡’_ : ğ’ â†’ ğ’ â†’ Set
Î” â‡’ Î“ = Î” â†’ Î“

id : âˆ€ {Î“} â†’ Î“ â‡’ Î“
id x = x

_âˆ˜_ : âˆ€ {Î Î” Î“} â†’ (Î” â‡’ Î“) â†’ (Î â‡’ Î”) â†’ (Î â‡’ Î“)
(Î³ âˆ˜ Î´) x = Î³ (Î´ x)

âˆ™ : ğ’
âˆ™ = âŠ¤

âŸ¨âŸ© : âˆ€ {Î“} â†’ Î“ â‡’ âˆ™
âŸ¨âŸ© _ = tt

-- Ty are types that depend on a context

Ty : ğ’ â†’ Setâ‚
Ty Î“ = Î“ â†’ Set

infixl 40 _[_]
_[_] : âˆ€ {Î” Î“} â†’ Ty Î“ â†’ (Î” â‡’ Î“) â†’ Ty Î”
(A [ Î³ ]) x = A (Î³ x)

-- Tm are terms of Ty

Tm : âˆ€ Î“ â†’ Ty Î“ â†’ Set
Tm Î“ A = (x : Î“) â†’ A x

infixl 40 _âŸ®_âŸ¯
_âŸ®_âŸ¯ : âˆ€ {Î” Î“} {A : Ty Î“} â†’ Tm Î“ A â†’ (Î³ : Î” â‡’ Î“) â†’ Tm Î” (A [ Î³ ])
(a âŸ® Î³ âŸ¯) x = a (Î³ x)

-- Contexts are lists of types

infixl 30 _â–·_
record _â–·_ (Î“ : ğ’) (A : Ty Î“) : ğ’ where
  constructor _âˆ·_
  field
    p : Î“
    q : A p
open _â–·_

âŸ¨_,_âŸ© : âˆ€ {Î” Î“} {A : Ty Î“} â†’ (Î³ : Î” â‡’ Î“) â†’ Tm Î” (A [ Î³ ]) â†’ (Î” â‡’ Î“ â–· A)
âŸ¨ Î³ , a âŸ© x = Î³ x âˆ· a x

_â†‘_ : âˆ€ {Î” Î“ : ğ’} â†’ (Î³ : Î” â‡’ Î“) â†’ (A : Ty Î“) â†’ (Î” â–· A [ Î³ ] â‡’ Î“ â–· A)
Î³ â†‘ A = âŸ¨ Î³ âˆ˜ p , q âŸ©

-- âŠ¥-structure
open import Data.Empty renaming (âŠ¥ to âŠ¥â€²)

âŠ¥ : âˆ€ {Î“} â†’ Ty Î“
âŠ¥ _ = âŠ¥â€²

abs : âˆ€ {Î“} â†’ (A : Ty Î“) â†’ Tm Î“ âŠ¥ â†’ Tm Î“ A
abs _ b x = âŠ¥-elim (b x)

-- Î -structure

Î  : âˆ€ {Î“} â†’ (A : Ty Î“) â†’ Ty (Î“ â–· A) â†’ Ty Î“
Î  A B x = (a : A x) â†’ B (x âˆ· a)

lam : âˆ€ {Î“} {A : Ty Î“} {B : Ty (Î“ â–· A)} â†’
      Tm (Î“ â–· A) B â†’ Tm Î“ (Î  A B)
lam b x a = b (x âˆ· a)

app : âˆ€ {Î“} {A : Ty Î“} {B : Ty (Î“ â–· A)} â†’
      Tm Î“ (Î  A B) â†’ Tm (Î“ â–· A) B
app b (x âˆ· a) = b x a

-- ğ’°-structure

data ğ’°â€² : Set
elâ€² : ğ’°â€² â†’ Set

data ğ’°â€² where
  âŠ¥á¶œâ€² : ğ’°â€²
  Î á¶œâ€² : (A : ğ’°â€²) â†’ (elâ€² A â†’ ğ’°â€²) â†’ ğ’°â€²

elâ€² âŠ¥á¶œâ€² = âŠ¥â€²
elâ€² (Î á¶œâ€² A B) = (a : elâ€² A) â†’ elâ€² (B a)

ğ’° : âˆ€ {Î“} â†’ Ty Î“
ğ’° _ = ğ’°â€²

el : âˆ€ {Î“} â†’ Tm Î“ ğ’° â†’ Ty Î“
el t x = elâ€² (t x)

âŠ¥á¶œ : âˆ€ {Î“} â†’ Tm Î“ ğ’°
âŠ¥á¶œ _ = âŠ¥á¶œâ€²

Î á¶œ : âˆ€ {Î“} â†’ (A : Tm Î“ ğ’°) â†’ Tm (Î“ â–· el A) ğ’° â†’ Tm Î“ ğ’°
Î á¶œ A B x = Î á¶œâ€² (A x) (Î» a â†’ B (x âˆ· a))

absurd : âˆ€ {â„“} {A : Set â„“} â†’ Tm âˆ™ âŠ¥ â†’ A
absurd b = âŠ¥-elim (b tt)

{- Equations as definitional equalities -}
open import Relation.Binary.PropositionalEquality.Core

-- Category laws and terminality

ass : âˆ€ {Î˜ Î Î” Î“} {Î³ : Î” â‡’ Î“} {Î´ : Î â‡’ Î”} {Îµ : Î˜ â‡’ Î} â†’
      (Î³ âˆ˜ Î´) âˆ˜ Îµ â‰¡ Î³ âˆ˜ (Î´ âˆ˜ Îµ)
ass = refl

idl : âˆ€ {Î” Î“} {Î³ : Î” â‡’ Î“} â†’ id âˆ˜ Î³ â‰¡ Î³
idl = refl

idr : âˆ€ {Î” Î“} {Î³ : Î” â‡’ Î“} â†’ Î³ âˆ˜ id â‰¡ Î³
idr = refl

âŸ¨âŸ©Î· : âˆ€ {Î“} {Î³ : Î“ â‡’ âˆ™} â†’ Î³ â‰¡ âŸ¨âŸ©
âŸ¨âŸ©Î· = refl

-- Ty and Tm functor laws

[id] : âˆ€ {Î“} {A : Ty Î“} â†’ A [ id ] â‰¡ A
[id] = refl

[âˆ˜] : âˆ€ {Î Î” Î“} {Î³ : Î” â‡’ Î“} {Î´ : Î â‡’ Î”} {A : Ty Î“} â†’
      A [ Î³ ] [ Î´ ] â‰¡ A [ Î³ âˆ˜ Î´ ]
[âˆ˜] = refl

âŸ®idâŸ¯ : âˆ€ {Î“} {A : Ty Î“} {a : Tm Î“ A} â†’ a âŸ® id âŸ¯ â‰¡ a
âŸ®idâŸ¯ = refl

âŸ®âˆ˜âŸ¯ : âˆ€ {Î Î” Î“} {Î³ : Î” â‡’ Î“} {Î´ : Î â‡’ Î”} {A : Ty Î“} {a : Tm Î“ A} â†’
      a âŸ® Î³ âˆ˜ Î´ âŸ¯ â‰¡ a âŸ® Î³ âŸ¯ âŸ® Î´ âŸ¯
âŸ®âˆ˜âŸ¯ = refl

-- Context comprehension laws

infix 40 _âˆ‹âŸ¨_,_âŸ©
_âˆ‹âŸ¨_,_âŸ© : âˆ€ {Î” Î“} â†’ (A : Ty Î“) â†’ (Î³ : Î” â‡’ Î“) â†’ Tm Î” (A [ Î³ ]) â†’ (Î” â‡’ Î“ â–· A)
_ âˆ‹âŸ¨ Î³ , a âŸ© = âŸ¨ Î³ , a âŸ©

pÎ² : âˆ€ {Î” Î“} {A : Ty Î“} {Î³ : Î” â‡’ Î“} {a : Tm Î” (A [ Î³ ])} â†’
     p {Î“} {A} âˆ˜ âŸ¨ Î³ , a âŸ© â‰¡ Î³
pÎ² = refl

qÎ² : âˆ€ {Î” Î“} {A : Ty Î“} {Î³ : Î” â‡’ Î“} {a : Tm Î” (A [ Î³ ])} â†’
     q {Î“} {A} âŸ® âŸ¨ Î³ , a âŸ© âŸ¯ â‰¡ a
qÎ² = refl

âŸ¨pqâŸ© : âˆ€ {Î“} {A : Ty Î“} â†’ âŸ¨ p , q âŸ© â‰¡ id {Î“ â–· A}
âŸ¨pqâŸ© = refl

âŸ¨âŸ©âˆ˜ : âˆ€ {Î Î” Î“} {Î³ : Î” â‡’ Î“} {Î´ : Î â‡’ Î”} {A : Ty Î“} {a : Tm Î” (A [ Î³ ])} â†’
      A âˆ‹âŸ¨ Î³ , a âŸ© âˆ˜ Î´ â‰¡ âŸ¨ Î³ âˆ˜ Î´ , a âŸ® Î´ âŸ¯ âŸ©
âŸ¨âŸ©âˆ˜ = refl

-- âŠ¥-stucture substitution laws

âŠ¥[] : âˆ€ {Î” Î“} {Î³ : Î” â‡’ Î“} â†’ âŠ¥ [ Î³ ] â‰¡ âŠ¥
âŠ¥[] = refl

absâŸ®âŸ¯ : âˆ€ {Î” Î“} {Î³ : Î” â‡’ Î“} â†’ {A : Ty Î“} â†’ {a : Tm Î“ âŠ¥} â†’
        (abs A a) âŸ® Î³ âŸ¯ â‰¡ abs (A [ Î³ ]) (a âŸ® Î³ âŸ¯)
absâŸ®âŸ¯ = refl

-- Î -structure computation, uniqueness, and substitution laws

Î Î² : âˆ€ {Î“} {A : Ty Î“} {B : Ty (Î“ â–· A)} {b : Tm (Î“ â–· A) B} â†’
     app (lam b) â‰¡ b
Î Î² = refl

Î Î· : âˆ€ {Î“} {A : Ty Î“} {B : Ty (Î“ â–· A)} {a : Tm Î“ (Î  A B)} â†’
     lam (app a) â‰¡ a
Î Î· = refl

Î [] : âˆ€ {Î” Î“} {A : Ty Î“} {B : Ty (Î“ â–· A)} {Î³ : Î” â‡’ Î“} â†’
      (Î  A B) [ Î³ ] â‰¡ Î  (A [ Î³ ]) (B [ Î³ â†‘ A ])
Î [] = refl

lamâŸ®âŸ¯ : âˆ€ {Î” Î“} {A : Ty Î“} {B : Ty (Î“ â–· A)} {Î³ : Î” â‡’ Î“} {b : Tm (Î“ â–· A) B} â†’
        (lam b) âŸ® Î³ âŸ¯ â‰¡ lam (b âŸ® Î³ â†‘ A âŸ¯)
lamâŸ®âŸ¯ = refl

appâŸ®âŸ¯ : âˆ€ {Î” Î“} {A : Ty Î“} {B : Ty (Î“ â–· A)} {Î³ : Î” â‡’ Î“} {a : Tm Î“ (Î  A B)} â†’
        (app a) âŸ® Î³ â†‘ A âŸ¯ â‰¡ app (a âŸ® Î³ âŸ¯)
appâŸ®âŸ¯ = refl

-- ğ’°-structure computation and substitution laws

âŠ¥á¶œÎ² : âˆ€ {Î“} â†’ el {Î“} âŠ¥á¶œ â‰¡ âŠ¥
âŠ¥á¶œÎ² = refl

Î á¶œÎ² : âˆ€ {Î“} {A : Tm Î“ ğ’°} {B : Tm (Î“ â–· el A) ğ’°} â†’
      el (Î á¶œ A B) â‰¡ Î  (el A) (el B)
Î á¶œÎ² = refl

ğ’°[] : âˆ€ {Î” Î“} {Î³ : Î” â‡’ Î“} â†’ ğ’° [ Î³ ] â‰¡ ğ’°
ğ’°[] = refl

el[] : âˆ€ {Î” Î“} {Î³ : Î” â‡’ Î“} {a : Tm Î“ ğ’°} â†’ (el a) [ Î³ ] â‰¡ el (a âŸ® Î³ âŸ¯)
el[] = refl

âŠ¥á¶œâŸ®âŸ¯ : âˆ€ {Î” Î“} {Î³ : Î” â‡’ Î“} â†’ (âŠ¥á¶œ âŸ® Î³ âŸ¯) â‰¡ âŠ¥á¶œ
âŠ¥á¶œâŸ®âŸ¯ = refl

Î á¶œâŸ®âŸ¯ : âˆ€ {Î” Î“} {Î³ : Î” â‡’ Î“} {A : Tm Î“ ğ’°} {B : Tm (Î“ â–· el A) ğ’°} â†’
       (Î á¶œ A B) âŸ® Î³ âŸ¯ â‰¡ Î á¶œ (A âŸ® Î³ âŸ¯) (B âŸ® Î³ â†‘ el A âŸ¯)
Î á¶œâŸ®âŸ¯ = refl